{include file="public/header" /}
{include file="public/menu"}
<link href="__SUP__/content/plugins/jstree/dist/themes/default/style.min.css?713" rel="stylesheet" />
<style type="text/css">
    #tree{
        font-size: 18px;
    }
</style>
<section class="content">
    <div id="toolbar" class="btn-group col-sm-12">
        <button id="btn_add" type="button" class="btn btn-primary">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
        </button>
        <button id="btn_edit" type="button" class="btn btn-primary">
            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
        </button>
        <button id="btn_delete" type="button" class="btn btn-primary">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
        </button>
    </div>
    <div id="tree" class="col-sm-12">
        <ul><!--输出4级-->
            {volist name="tree" id="data"}
                <li cat-name="{$data.cat_name}" parent-id="{$data.parent_id}" cat-id="{$data.cat_id}" >{$data.cat_name}
                    {php}if(isset($data['sub_cat'])){{/php}
                        <ul>
                            {volist name="data['sub_cat']" id="datas"}
                                <li cat-name="{$datas.cat_name}" parent-id="{$datas.parent_id}" cat-id="{$datas.cat_id}">{$datas.cat_name}
                                    {php}if(isset($datas['sub_cat'])){{/php}
                                            <ul>
                                                {volist name="datas['sub_cat']" id="datass"}
                                                    <li cat-name="{$datass.cat_name}" parent-id="{$datass.parent_id}" cat-id="{$datass.cat_id}">{$datass.cat_name}
                                                        {php}if(isset($datass['sub_cat'])){{/php}
                                                        <ul>
                                                            {volist name="datass['sub_cat']" id="datasss"}
                                                            <li cat-name="{$datasss.cat_name}" parent-id="{$datasss.parent_id}" cat-id="{$datasss.cat_id}">{$datasss.cat_name}</li>
                                                            {/volist}
                                                        </ul>
                                                        {php}}{/php}
                                                    </li>
                                                {/volist}
                                            </ul>
                                    {php}}{/php}
                                </li>
                            {/volist}
                        </ul>
                    {php}}{/php}
                </li>
            {/volist}
        </ul>
    </div>
</section>
{include file="public/footer" /}
<script src="__SUP__/content/plugins/jstree/dist/jstree.min.js"></script>
<script type="text/javascript">
$(function () {
    $('#tree').jstree({
        "core": {
            "themes": {
                "responsive": false
            }
        },
        "types": {
            "default": {
                "icon": "fa fa-folder icon-state-warning icon-lg"
            },
        },
        "plugins": ["types"]
    });
    $('#btn_add').on('click',function () {
        var d = dialog({
            title: '添加分类',
            content: '<form class="form-horizontal" action="/admin/goods/goods_cat_add" method="post">' +
                        '<div class="form-group">' +
                            '<label for="cat_name" class="col-sm-4 control-label">分类名</label>' +
                                '<div class="col-sm-8">' +
                                    '<input type="text" class="form-control" name="cat_name" id="cat_name" placeholder="分类名">' +
                                '</div>' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label for="parent_id" class="col-sm-4 control-label">上级分类</label>' +
                            '<div class="col-sm-8" >' +
                                '<select name="parent_id"  id="parent_id" class="form-control">' +
                                    '<option value="0">顶级分类</option>' +
            '{volist name="cat_info" id="data" }<option value="{$data.cat_id}">{php}echo str_repeat("&nbsp;",5*$data["level"]);{/php}{$data.cat_name}</option>{/volist}' +
                                '</select>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-sm-8 col-sm-push-4">' +
                            '<button type="button" class="btn btn-primary add_btn">添加分类</button>' +
                        '</div>' +
                    '</form>'
        });
        d.show();
    });
    $('body').on('click','.add_btn',function () {
        //添加分类验证
        if($('#cat_name').val() == ""){
            alert("分类名不能为空");
            return false;
        }
        else{
            $(this).attr('type','submit');
        }
    });
    $('#btn_edit').on('click',function () {
        if($('.jstree-clicked').length){
            var cat_name = $('.jstree-clicked').parent('li').attr('cat-name');
            var parent_id = $('.jstree-clicked').parent('li').attr('parent-id');
            var cat_id = $('.jstree-clicked').parent('li').attr('cat-id');

            var html = '<form class="form-horizontal" action="/admin/goods/goods_cat_edit" method="post">' +
                            '<div class="form-group">' +
                                '<label for="cat_name" class="col-sm-4 control-label">分类名</label>' +
                                '<div class="col-sm-8">' +
                                    '<input type="text" class="form-control" value="'+ cat_name +'" name="cat_name" id="cat_name" placeholder="分类名">' +
                                '</div>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label for="parent_id" class="col-sm-4 control-label">上级分类</label>' +
                                '<div class="col-sm-8" >' +
                                    '<select name="parent_id"  id="parent_id" class="form-control">' +
                                        '<option value="0">顶级分类</option>' +
                                        '{volist name="cat_info" id="data" }<option value="{$data.cat_id}"  ';
                if(parseInt(parent_id) == parseInt('{$data.cat_id}')){
                    html+=' selected="selected"';
                }
                html+=' >{php}echo str_repeat("&nbsp;",5*$data["level"]);{/php}{$data.cat_name}</option>{/volist}' +
                                    '</select>' +
                                '</div>' +
                            '</div>' +
                            '<div class="col-sm-8 col-sm-push-4">' +
                                '<input  type="hidden" value="'+ cat_id +'" name="cat_id">' +
                                '<button type="button" class="btn btn-primary edit_btn">确认修改</button>' +
                            '</div>' +
                        '</form>';
            var d = dialog({
                title: '修改分类',
                content: html,
            });
            d.show();
        }
    });
    $('body').on('click','.edit_btn',function () {
        //编辑分类验证
        if($('#cat_name').val() == ""){
            alert("分类名不能为空");
            return false;
        }
        else{
            $(this).attr('type','submit');
        }
    });
    $('#btn_delete').on('click',function () {
        if($('.jstree-clicked').length){
            if(confirm('确定要删除吗')){
                var cat_id = $('.jstree-clicked').parent('li').attr('cat-id');
                window.location.href ='/admin/goods/goods_cat_delete/cat_id/'+cat_id;
            }
        }
    });
});
</script>